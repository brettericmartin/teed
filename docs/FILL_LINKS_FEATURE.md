# Auto-Fill Links Feature

**Version:** 1.0.0
**Last Updated:** 2025-11-18

---

## Overview

The "Fill Links" feature automatically generates product search links for bag items that don't have user-created links. This ensures every item can have a product link while respecting user-created links.

---

## Key Features

âœ… **User Links Protected** - Never replaces user-created links
âœ… **Smart Detection** - Only fills items without existing user links
âœ… **Visual Indicator** - Shows "TEED" badge for auto-generated links
âœ… **Google Shopping** - Auto-generates Google Shopping search links
âœ… **Brand-Aware** - Includes brand name in search query when available

---

## Database Schema

### Migration 014: Add Auto-Generated Flag

**File:** `scripts/migrations/014_add_auto_generated_flag.sql`

```sql
ALTER TABLE links
ADD COLUMN IF NOT EXISTS is_auto_generated boolean DEFAULT false NOT NULL;
```

**To Run:** Copy and paste into Supabase SQL Editor

---

## API Endpoint

### POST /api/items/fill-links

Auto-generates product links for items without user-created links.

**Request:**
```json
{
  "bagId": "uuid-of-bag"
}
```

**Response:**
```json
{
  "processed": 10,
  "linksAdded": 7,
  "items": [
    {
      "itemId": "uuid",
      "linkAdded": true
    },
    {
      "itemId": "uuid",
      "linkAdded": false,
      "reason": "Item already has user-created links"
    }
  ]
}
```

---

## How It Works

### 1. **Protection Logic**

The system checks for existing links and respects user-created links:

```typescript
// Get existing links
const existingLinks = await fetchLinks(itemIds);

// Identify items with USER-created links
const itemsWithUserLinks = new Set(
  existingLinks
    ?.filter(link => !link.is_auto_generated)
    .map(link => link.bag_item_id)
);

// Skip items with user links
if (itemsWithUserLinks.has(item.id)) {
  // âœ… User link protected - skip auto-generation
  continue;
}
```

### 2. **Link Generation**

For items without user links:

```typescript
// Generate search query
const searchQuery = item.brand
  ? `${item.brand} ${item.custom_name}`
  : item.custom_name;

// Create Google Shopping link
const url = `https://www.google.com/search?tbm=shop&q=${encodeURIComponent(searchQuery)}`;

// Insert with auto-generated flag
await createLink({
  bag_item_id: item.id,
  url: url,
  kind: 'product',
  label: 'Find on Google Shopping',
  is_auto_generated: true, // ðŸ”‘ Key flag
});
```

### 3. **Visual Indicator**

Auto-generated links show a "TEED" badge:

**Edit View:**
```tsx
{link.is_auto_generated && (
  <span className="text-xs px-1.5 py-0.5 bg-[var(--teed-green-3)] text-[var(--teed-green-11)] rounded font-medium">
    TEED
  </span>
)}
```

**Public View:**
```tsx
{link.is_auto_generated && (
  <span className="inline-flex items-center px-2 py-1 bg-[var(--teed-green-3)] text-[var(--teed-green-11)] rounded-lg text-xs font-medium" title="Auto-generated by Teed">
    TEED
  </span>
)}
```

---

## UI Components

### Fill Links Button

**Location:** Bag Editor - below "Add from Photo" and "Find Photos" buttons

```tsx
<Button
  onClick={handleFillLinks}
  disabled={isFillingLinks}
  variant="secondary"
  className="w-full py-3"
>
  {isFillingLinks ? (
    <>
      <Loader2 className="w-5 h-5 mr-2 animate-spin" />
      Filling Links...
    </>
  ) : (
    <>
      <Link className="w-5 h-5 mr-2" />
      Fill Product Links
    </>
  )}
</Button>
```

**Only shows when:** `bag.items.length > 0`

---

## User Flow

### 1. Creator Workflow

1. **Create Items** - Add golf clubs, gear, etc. to bag
2. **Add User Links** (Optional) - Add specific product/review links
3. **Fill Links** - Click "Fill Product Links" button
4. **Result:**
   - Items with user links: Unchanged âœ…
   - Items without links: Google Shopping link added with "TEED" badge

### 2. Visitor Experience

**Public Bag View:**
- See both user links and TEED-generated links
- TEED badge clearly distinguishes auto-generated links
- Click any link to search/purchase

---

## Skip Scenarios

The system **skips** auto-generation when:

| Scenario | Reason | Message |
|----------|--------|---------|
| Has user link | Protect user content | "Item already has user-created links" |
| Has auto-link | Already filled | "Item already has auto-generated link" |
| No product name | Can't search | "No product name available" |

---

## Examples

### Example 1: Mixed Bag

**Before Fill Links:**
```
Item 1: "TaylorMade Stealth Driver"
  â””â”€â”€ User Link: https://pgatoursuperstore.com/...

Item 2: "Titleist Pro V1"
  â””â”€â”€ (no links)

Item 3: "Callaway Rogue ST"
  â””â”€â”€ (no links)
```

**After Fill Links:**
```
Item 1: "TaylorMade Stealth Driver"
  â””â”€â”€ User Link: https://pgatoursuperstore.com/... (unchanged)

Item 2: "Titleist Pro V1"
  â””â”€â”€ TEED: https://www.google.com/search?tbm=shop&q=Titleist+Pro+V1

Item 3: "Callaway Rogue ST"
  â””â”€â”€ TEED: https://www.google.com/search?tbm=shop&q=Callaway+Rogue+ST
```

**Result:** 2 links added (Items 2 & 3), Item 1 protected

### Example 2: With Brands

**Item:** "Stealth 2 Driver"
**Brand:** "TaylorMade"

**Generated Link:**
```
https://www.google.com/search?tbm=shop&q=TaylorMade+Stealth+2+Driver
```

---

## Technical Implementation

### Files Modified

1. **Migration:**
   - `scripts/migrations/014_add_auto_generated_flag.sql`

2. **API Endpoint:**
   - `app/api/items/fill-links/route.ts` (new)

3. **Editor UI:**
   - `app/u/[handle]/[code]/edit/BagEditorClient.tsx`
   - `app/u/[handle]/[code]/edit/components/ItemCard.tsx`

4. **Public View:**
   - `app/u/[handle]/[code]/PublicBagView.tsx`

### Type Updates

All Link types now include:

```typescript
type Link = {
  id: string;
  url: string;
  kind: string;
  metadata: any;
  created_at: string;
  is_auto_generated?: boolean; // ðŸ†•
};
```

---

## Testing

### Manual Test

1. Create a new bag with multiple items
2. Add a user link to one item
3. Click "Fill Product Links"
4. **Verify:**
   - âœ… Item with user link unchanged
   - âœ… Items without links now have Google Shopping links
   - âœ… TEED badge appears on auto-generated links
   - âœ… No user links were replaced

### API Test

```bash
# Test fill links endpoint
curl -X POST http://localhost:3000/api/items/fill-links \
  -H "Content-Type: application/json" \
  -H "Cookie: your-auth-cookie" \
  -d '{"bagId":"your-bag-id"}' | jq
```

---

## Future Enhancements

### Phase 2 (Optional)

- [ ] Allow users to regenerate auto-links
- [ ] Support multiple search engines (Amazon, eBay, etc.)
- [ ] AI-powered product matching for better links
- [ ] Affiliate link integration for auto-generated links
- [ ] Batch delete all auto-generated links

---

## Troubleshooting

### Links Not Generated

**Check:**
1. Migration 014 has been run (check for `is_auto_generated` column)
2. Items have a `custom_name` value
3. No existing links on items (user or auto-generated)

### User Links Replaced

**This should never happen!** If it does:
1. Check `is_auto_generated` is properly set to `false` for user links
2. Review the skip logic in `/api/items/fill-links/route.ts`
3. File a bug report

### TEED Badge Not Showing

**Check:**
1. Link has `is_auto_generated: true` in database
2. Component types include `is_auto_generated?: boolean`
3. Browser cache cleared

---

## Summary

The Fill Links feature provides:

âœ… **Safety First** - User links are never modified
âœ… **Convenience** - Auto-fills Google Shopping links
âœ… **Transparency** - Clear TEED badge on auto-links
âœ… **Flexibility** - Users can delete/replace auto-links anytime

This ensures every item has at least one product link while respecting creator content!

---

**END OF DOCUMENT**
